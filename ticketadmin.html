<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONTROL | MÓDULO DE TURNOS AGI (SECUENCIAL)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Estilos de Control */
        :root {
            --color-principal: #17a2b8; /* Cian/Teal */
            --color-secundario: #28a745; /* Verde */
            --color-peligro: #dc3545; /* Rojo */
            --color-alerta: #ffc107; /* Amarillo */
            --color-fondo: #f8f9fa;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 0; color: #333; background-color: var(--color-fondo);
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .box { 
            background: white; padding: 30px; border-radius: 12px; width: 450px; 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25); text-align: center;
            border-top: 5px solid var(--color-secundario); 
        }
        h1 {
            color: var(--color-principal); border-bottom: 2px solid var(--color-principal);
            padding-bottom: 10px; margin-top: 0; font-size: 1.8em;
        }
        h2 { margin-bottom: 5px; color: #333; padding-top: 15px; font-size: 1.2em; }
        #currentTurn { font-size: 5em; font-weight: 800; color: var(--color-peligro); margin: 10px 0 0 0; display: block; }
        #attendantName { font-size: 1.4em; color: var(--color-principal); font-weight: 600; margin-top: 5px; margin-bottom: 20px; display: block; }
        #colaStatus { font-size: 1.1em; color: var(--color-secundario); margin-bottom: 20px; font-weight: bold; border: 1px dashed #ddd; padding: 10px; border-radius: 6px; }
        
        button { 
            padding: 15px 15px; margin-top: 15px; cursor: pointer; width: 100%; 
            border: none; border-radius: 6px; font-weight: bold; text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); transition: all 0.2s;
        }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); }
        button:nth-of-type(1) { background-color: var(--color-secundario); color: white; } /* Cambiado a Verde para reflejar FIFO/Orden */
        button:nth-of-type(2) { background-color: var(--color-principal); color: white; } 
        button:nth-of-type(3) { background-color: var(--color-peligro); color: white; } 
        button.screen-btn { background-color: var(--color-alerta); color: #333; }

        /* Estilos Pantalla de Llamada (Para la función abrirPantallaLlamada) */
        .call-screen-body { background-color: #f5f5f5; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        .call-screen-body p { font-size: 3.5rem; margin: 0; color: #666; font-weight: 300; }
        #called-turn { font-size: 18rem; color: #17a2b8; margin: 10px 0; animation: pulse 1s infinite alternate; letter-spacing: 5px; font-weight: 900; text-shadow: 0 5px 10px rgba(0, 0, 0, 0.1); }
        #attendant-display { font-size: 4rem; color: #28a745; margin-top: 20px; font-weight: 600; }
        @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.02); } }
    </style>
</head>
<body>

<div class="box">
    <h1><i class="fa-solid fa-notes-medical"></i> CONTROL DE LLAMADAS AGI</h1>
    
    <h2>>> TURNO LLAMADO</h2>
    <span id="currentTurn">N/A</span>
    <span id="attendantName">--- LISTO PARA LLAMAR ---</span>

    <p id="colaStatus">Tickets en cola: 0</p>

    <button onclick="llamarSiguienteTurno()">
        <i class="fa-solid fa-person-walking-arrow-right"></i> LLAMAR SIGUIENTE TURNO (FIFO)
    </button>
    <button onclick="imprimirTurnoActual()">
        <i class="fa-solid fa-print"></i> RE-IMPRIMIR TURNO EN LLAMADA
    </button>
    <button onclick="limpiarContadores()">
        <i class="fa-solid fa-arrows-rotate"></i> REINICIAR SISTEMA (FIN DE DÍA)
    </button>
    <button class="screen-btn" onclick="abrirPantallaLlamada(turnoActual, MENSAJE_PASE)" style="margin-bottom: 0;">
        <i class="fa-solid fa-desktop"></i> ABRIR PANTALLA DE LLAMADA
    </button>
</div>

<audio id="campana" src="https://www.soundjay.com/buttons/beep-01a.mp3" preload="auto"></audio>

<script>
// --- CONSTANTES DE LOCALSTORAGE (Sincronización) ---
const CLAVE_COLA = 'agiColaTickets';
const CLAVE_TURNO_ACTUAL = 'agiTurnoActual'; 
const CLAVE_CONTADOR_TOTAL = 'agiContadorTotal'; 

// --- ESTADO Y VARIABLES GLOBALES ---
let colaTickets = [];
let turnoActual = "N/A";
let ventanaLlamada = null; 
const campana = document.getElementById('campana');
const MENSAJE_PASE = "PASE AL ÁREA DE ATENCIÓN";


// ====================================================
// A. FUNCIONES DE PERSISTENCIA Y CARGA
// ====================================================

function cargarEstado() {
    colaTickets = JSON.parse(localStorage.getItem(CLAVE_COLA) || '[]');
    turnoActual = localStorage.getItem(CLAVE_TURNO_ACTUAL) || 'N/A';
    
    actualizarVistaControl();
    
    // Abrir la pantalla de llamada si hay un turno activo
    if(turnoActual !== 'N/A') {
        abrirPantallaLlamada(turnoActual, MENSAJE_PASE);
    }
}

function guardarEstado() {
    localStorage.setItem(CLAVE_COLA, JSON.stringify(colaTickets));
    localStorage.setItem(CLAVE_TURNO_ACTUAL, turnoActual);
}

function actualizarVistaControl() {
    const mensajeControl = (turnoActual !== 'N/A') ? 'TURNO ACTIVO' : 'LISTO PARA LLAMAR';

    document.getElementById("currentTurn").textContent = turnoActual;
    document.getElementById("attendantName").textContent = mensajeControl; 
    
    document.getElementById("colaStatus").textContent = `Tickets en cola: ${colaTickets.length}`;

    guardarEstado();
}


// ====================================================
// B. SONDEO (POLLING) PARA SINCRONIZACIÓN
// ====================================================

function verificarColaPublica() {
    const colaGuardadaJSON = localStorage.getItem(CLAVE_COLA);
    
    if (colaGuardadaJSON) {
        const nuevaCola = JSON.parse(colaGuardadaJSON);
        
        if (colaTickets.length !== nuevaCola.length) {
            colaTickets = nuevaCola;
            actualizarVistaControl(); 
        }
    }
}

// Inicia el sondeo: comprueba la cola cada 3 segundos
setInterval(verificarColaPublica, 3000); 


// ====================================================
// C. FUNCIÓN PRINCIPAL DE LLAMADA SECUENCIAL (FIFO)
// ====================================================

function llamarSiguienteTurno() {
    verificarColaPublica(); 
    
    if (colaTickets.length === 0) {
        alert("ERROR: COLA DE TICKETS VACÍA. Genere tickets en el módulo público.");
        return;
    }

    // 1. EXTRAER EL PRIMER TICKET DE LA COLA (MÉTODO FIFO)
    const ticketLlamado = colaTickets.shift(); 
    
    turnoActual = ticketLlamado;

    // 2. Guardar la cola reducida y actualizar la vista
    actualizarVistaControl(); 
    
    // 3. Enviar a la pantalla grande con el mensaje genérico
    enviarTurnoAPantalla(turnoActual, MENSAJE_PASE);
}


// ====================================================
// D. LIMPIEZA DEL SISTEMA
// ====================================================
function limpiarContadores() {
    if (confirm("ADVERTENCIA: ¿ESTÁ SEGURO DE REINICIAR TODO EL SISTEMA? Esto eliminará todos los tickets en cola.")) {
        
        colaTickets = [];
        turnoActual = "N/A";

        localStorage.removeItem(CLAVE_COLA);
        localStorage.removeItem(CLAVE_TURNO_ACTUAL);
        localStorage.setItem(CLAVE_CONTADOR_TOTAL, '0');
        
        actualizarVistaControl();

        if (ventanaLlamada && !ventanaLlamada.closed) {
            enviarTurnoAPantalla("N/A", "--- SISTEMA REINICIADO ---");
        }
        
        alert("ESTADO DEL SISTEMA: REINICIO COMPLETO. Por favor, reinicie la página de generación de tickets.");
    }
}


// ====================================================
// E. FUNCIONES AUXILIARES (PANTALLA LLAMADA / IMPRESIÓN)
// ====================================================

function enviarTurnoAPantalla(turno, mensaje) {
    campana.currentTime = 0; 
    campana.play().catch(e => console.error("No se pudo reproducir el audio:", e));
    
    if (ventanaLlamada && !ventanaLlamada.closed) {
        ventanaLlamada.postMessage({ 
            type: 'updateTurn', 
            turno: turno, 
            nombre: mensaje 
        }, '*');
        ventanaLlamada.focus(); 
    } else {
        abrirPantallaLlamada(turno, mensaje);
    }
}

function abrirPantallaLlamada(turnoDisplay, nombreDisplay) {
    const contenidoHTML = `
        <!DOCTYPE html>
        <html lang="es">
        <head>
            <title>AGI :: PANTALLA DE LLAMADA</title>
            <style>
                .call-screen-body { background-color: #f5f5f5; color: #333; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
                .call-screen-body div { text-align: center; }
                .call-screen-body p { font-size: 3.5rem; margin: 0; color: #666; font-weight: 300; }
                #called-turn { font-size: 18rem; color: #17a2b8; margin: 10px 0; animation: pulse 1s infinite alternate; letter-spacing: 5px; font-weight: 900; text-shadow: 0 5px 10px rgba(0, 0, 0, 0.1); }
                #attendant-display { font-size: 4rem; color: #28a745; margin-top: 20px; font-weight: 600; }
                @keyframes pulse { 0% { transform: scale(1); } 100% { transform: scale(1.02); } }
            </style>
        </head>
        <body class="call-screen-body">
            <div>
                <p>TURNO LLAMADO</p>
                <span id="called-turn">${turnoDisplay}</span>
                <span id="attendant-display">${nombreDisplay}</span>
            </div>

            <script>
                window.addEventListener('message', function(event) {
                    if (event.data.type === 'updateTurn') {
                        document.getElementById('called-turn').textContent = event.data.turno;
                        document.getElementById('attendant-display').textContent = event.data.nombre || "--- EN ESPERA ---";
                    }
                });
            <\/script>
        </body>
        </html>
    `;

    ventanaLlamada = window.open('', 'AGI_PANTALLA_LLAMADA', 'width=1200,height=800');
    if (ventanaLlamada) {
        ventanaLlamada.document.write(contenidoHTML);
        ventanaLlamada.document.close();
    } else {
        alert("ACCESO DENEGADO: Bloqueador de pop-ups activo. No se puede abrir la pantalla de llamada.");
    }
}

function imprimirTurnoActual() {
    if (turnoActual === "N/A") {
        alert("ERROR: NO HAY LLAMADA ACTIVA PARA IMPRIMIR.");
        return;
    }
    abrirVentanaImpresion(turnoActual, MENSAJE_PASE);
}

function abrirVentanaImpresion(ticket, info) {
    const ventanaImpresion = window.open("", "ImprimirTicket", "width=350,height=300");
    
    if (!ventanaImpresion) {
        alert("ACCESO DENEGADO: Bloqueador de pop-ups activo. No se puede imprimir.");
        return;
    }
    
    const contenidoTicket = `
        <div id="ticket-print" style="font-family: monospace; text-align: center; color: #000;">
            <p style="font-size: 1.2em;">[TICKET DE TURNO]</p>
            <h1 style="font-size: 3em; color: #17a2b8; margin: 5px 0;">${ticket}</h1>
            <p style="font-size: 1.1em; margin-top: 0;">${info}</p>
            <p style="font-size: 0.8em; margin-top: 15px;">FECHA: ${new Date().toLocaleString()}</p>
            <hr style="border-top: 1px dashed #000; margin: 10px 0;">
            <p style="font-size: 0.8em;">-- GUARDE SU TURNO --</p>
        </div>
    `;

    ventanaImpresion.document.write(`
        <html><head><title>IMPRESIÓN TICKET</title><style>body { font-family: monospace; text-align: center; }</style></head><body>
            ${contenidoTicket}
            <script>window.onload = function() { window.print(); setTimeout(() => window.close(), 100); };<\/script>
        </body></html>
    `);
    ventanaImpresion.document.close();
}

// Inicializar el sistema al cargar la página
window.onload = cargarEstado;
</script>

</body>
</html>