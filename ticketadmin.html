<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGI | Administraci칩n de Turnos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* Estilos generales (Mantenidos del c칩digo anterior) */
        :root {
            --color-principal: #17a2b8; /* Cian/Teal */
            --color-secundario: #28a745; /* Verde Salud */
            --color-peligro: #dc3545; /* Rojo */
            --color-fondo: #f4f7f6;
            --color-fondo-admin: #343a40; /* Gris oscuro para el fondo de admin */
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; 
            padding: 0; 
            background-color: var(--color-fondo-admin); 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            color: #fff;
        }

        /* --- Estilos de la barra de navegaci칩n y el resto del layout --- */
        .navbar {
            background-color: #000;
            padding: 0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        .navbar ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: nowrap;
            justify-content: flex-start;
        }
        .navbar li a {
            display: block;
            padding: 15px 20px;
            text-decoration: none;
            color: white;
            font-size: 1em;
            white-space: nowrap;
            transition: background-color 0.3s;
        }
        .navbar li a:hover {
            background-color: var(--color-principal); 
        }
        .navbar li a i {
            margin-right: 8px;
        }
        .navbar li .nav-active {
            background-color: var(--color-secundario); 
            font-weight: bold;
        }
        
        /* --- Contenido Principal (Admin Panel) --- */
        .main-content {
            flex-grow: 1;
            padding: 20px;
            background-color: var(--color-fondo-admin); 
        }

        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            max-width: 1200px;
            margin: 20px auto;
        }
        
        .admin-box {
            background: #495057;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
            border-top: 5px solid var(--color-principal);
        }
        .admin-box h2 {
            color: var(--color-secundario);
            font-size: 1.5em;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #6c757d;
        }

        /* Control de Llamadas */
        #llamada-control {
            grid-column: 1 / 2;
        }

        #ticketLlamadoDisplay {
            font-size: 3em;
            font-weight: bold;
            color: var(--color-peligro);
            margin: 15px 0;
            text-align: center;
            background: #212529;
            padding: 10px;
            border-radius: 5px;
        }

        .admin-button {
            padding: 15px; 
            background-color: var(--color-principal); 
            color: white;
            border: none; 
            border-radius: 5px; 
            font-size: 1.1em; 
            font-weight: bold;
            cursor: pointer; 
            transition: background-color 0.3s;
            width: 100%;
            margin-top: 15px;
        }
        .admin-button:hover:not(:disabled) {
            background-color: #138496;
        }
        .admin-button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        /* Cola de Espera */
        #cola-espera {
            grid-column: 2 / 3;
        }
        #listaCola {
            list-style: none;
            padding: 0;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #6c757d;
            border-radius: 5px;
            margin-top: 15px;
        }
        #listaCola li {
            background-color: #5a6268;
            padding: 10px 15px;
            border-bottom: 1px solid #6c757d;
            font-size: 1.2em;
            font-weight: bold;
        }
        #listaCola li:first-child {
            background-color: var(--color-secundario);
            color: black;
        }
        #listaCola li.vacio {
            text-align: center;
            font-style: italic;
            color: #ccc;
            background-color: #5a6268;
        }

        /* Ajustes de Contador y Botones de Peligro (mantenidos) */
        #contador-status {
            grid-column: 1 / 2;
        }
        .status-info {
            margin-top: 15px;
            padding: 10px;
            background: #5a6268;
            border-radius: 5px;
            border-left: 5px solid var(--color-secundario);
        }
        .btn-danger {
            background-color: var(--color-peligro);
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        /* Media Query para Responsive (Mantenido) */
        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr; 
                margin: 0;
            }
            #llamada-control, #cola-espera, #contador-status {
                grid-column: 1 / 2;
            }
            .navbar ul {
                flex-wrap: wrap; 
                justify-content: center;
            }
            .navbar li {
                flex-basis: 33.33%;
            }
            .navbar li a span {
                display: none;
            }
            .navbar li a i {
                margin-right: 0; 
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>

<nav class="navbar">
    <ul>
        <li><a href="toma_de_turno.html"><i class="fa-solid fa-ticket"></i> <span>Toma de Turno</span></a></li> 
        <li><a href="ticketadmin.html" class="nav-active"><i class="fa-solid fa-screwdriver-wrench"></i> <span>Administraci칩n</span></a></li>
        <li><a href="inicio.html"><i class="fa-solid fa-house-chimney"></i> <span>Inicio</span></a></li>
        <li><a href="visor_datos.html"><i class="fa-solid fa-table-cells"></i> <span>Rendimiento M칠dico</span></a></li>
        <li><a href="instructivos.html"><i class="fa-solid fa-book-medical"></i> <span>Instructivos</span></a></li>
        <li><a href="formatos.html"><i class="fa-solid fa-file-invoice"></i> <span>Formatos</span></a></li>
    </ul>
</nav>

<div class="main-content">
    <div class="admin-grid">

        <div id="llamada-control" class="admin-box">
            <h2><i class="fa-solid fa-volume-up"></i> Control de Llamadas</h2>
            <p id="siguienteTurnoCola">Cargando...</p>

            <div id="ticketLlamadoDisplay">---</div>
            <p id="ticketLlamadoMessage">El 칰ltimo ticket llamado aparecer치 aqu칤.</p>

            <button id="btnLlamar" class="admin-button" onclick="llamarSiguienteTicket()">
                <i class="fa-solid fa-bullhorn"></i> LLAMAR SIGUIENTE TURNO
            </button>

            <button class="admin-button" onclick="abrirVisorEnPestana()">
                <i class="fa-solid fa-eye"></i> ABRIR VISOR DE P칔BLICO
            </button>
        </div>

        <div id="cola-espera" class="admin-box">
            <h2><i class="fa-solid fa-list-ol"></i> Cola de Espera</h2>
            <p id="estadoCola">Tickets en cola: 0</p>
            <ul id="listaCola">
                <li class="vacio">La cola est치 vac칤a.</li>
            </ul>
        </div>

        <div id="contador-status" class="admin-box">
            <h2><i class="fa-solid fa-cogs"></i> Estado del Sistema</h2>
            
            <div class="status-info">
                <p id="estadoContador">칔ltimo ticket generado: T-000</p>
                <p id="proximoGenerar">Pr칩ximo a generar: T-001</p>
            </div>

            <button class="admin-button btn-danger" onclick="resetearCola()">
                <i class="fa-solid fa-sync-alt"></i> REINICIAR COLA Y CONTADOR (1/100)
            </button>
        </div>

    </div>
</div>

<script>
// --- CONSTANTES DE LOCALSTORAGE ---
const CLAVE_COLA = 'agiColaTickets';
const CLAVE_CONTADOR_TOTAL = 'agiContadorTotal'; 

// Nombre de la ventana de visualizaci칩n (para evitar abrir m칰ltiples pesta침as)
const NOMBRE_VENTANA_VISOR = 'AGITicketVisor';

// ====================================================
// FUNCI칍N PRINCIPAL MODIFICADA: LLAMAR/DESPACHAR Y ABRIR VISOR
// ====================================================
function llamarSiguienteTicket() {
    let colaTickets = JSON.parse(localStorage.getItem(CLAVE_COLA) || '[]');
    
    if (colaTickets.length > 0) {
        const ticketLlamado = colaTickets.shift(); 
        
        localStorage.setItem(CLAVE_COLA, JSON.stringify(colaTickets));
        
        // 1. Mostrar feedback visual en el panel de admin
        document.getElementById('ticketLlamadoDisplay').textContent = ticketLlamado;
        document.getElementById('ticketLlamadoMessage').innerHTML = `<i class="fa-solid fa-check"></i> Ticket **${ticketLlamado}** ha sido llamado a atenci칩n.`;

        // 2. ABRIR EL VISOR EN UNA PESTA칌A NUEVA
        const urlVisor = `visor_ticket.html?ticket=${ticketLlamado}&modulo=AGI`;
        window.open(urlVisor, NOMBRE_VENTANA_VISOR); // Abre/actualiza la ventana con el ticket
        
    } else {
        document.getElementById('ticketLlamadoDisplay').textContent = '---';
        document.getElementById('ticketLlamadoMessage').innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i> No hay tickets pendientes en la cola.';
    }
    
    actualizarVistaAdmin();
}

// ====================================================
// FUNCI칍N AUXILIAR: ABRIR EL VISOR MANUALMENTE
// ====================================================
function abrirVisorEnPestana() {
    // Si la cola est치 vac칤a, muestra un mensaje por defecto o el 칰ltimo llamado.
    const ultimoLlamado = document.getElementById('ticketLlamadoDisplay').textContent;
    const ticketParam = ultimoLlamado === '---' ? 'Bienvenido' : ultimoLlamado;

    const urlVisor = `visor_ticket.html?ticket=${ticketParam}&modulo=AGI`;
    window.open(urlVisor, NOMBRE_VENTANA_VISOR);
}

// ====================================================
// FUNCI칍N: REINICIAR EL SISTEMA
// ====================================================
function resetearCola() {
    if (confirm("游뚿 ADVERTENCIA: 쮼st치 seguro de que desea reiniciar el contador de turnos y vaciar toda la cola? Esta acci칩n no se puede deshacer y afectar치 a la p치gina de toma de turno.")) {
        localStorage.removeItem(CLAVE_COLA); 
        localStorage.setItem(CLAVE_CONTADOR_TOTAL, '0');
        actualizarVistaAdmin();
        document.getElementById('ticketLlamadoDisplay').textContent = 'T-001';
        document.getElementById('ticketLlamadoMessage').innerHTML = '<i class="fa-solid fa-redo"></i> Sistema Reiniciado. El pr칩ximo ticket ser치 T-001.';
    }
}

// ====================================================
// FUNCI칍N: ACTUALIZAR VISTA DE ADMINISTRACI칍N (mantenida)
// ====================================================
function actualizarVistaAdmin() {
    let colaTickets = JSON.parse(localStorage.getItem(CLAVE_COLA) || '[]');
    const contador = parseInt(localStorage.getItem(CLAVE_CONTADOR_TOTAL) || '0', 10);
    
    // --- 1. Actualizar lista de cola ---
    const listaCola = document.getElementById('listaCola');
    listaCola.innerHTML = ''; 
    
    if (colaTickets.length > 0) {
        colaTickets.forEach(ticket => {
            const li = document.createElement('li');
            li.textContent = ticket;
            listaCola.appendChild(li);
        });
        document.getElementById('estadoCola').textContent = `Tickets en cola: ${colaTickets.length}`;
        document.getElementById('siguienteTurnoCola').textContent = `El siguiente turno a llamar es: ${colaTickets[0]}`;
        document.getElementById('btnLlamar').disabled = false;
    } else {
        listaCola.innerHTML = '<li class="vacio">La cola est치 vac칤a.</li>';
        document.getElementById('estadoCola').textContent = 'Tickets en cola: 0';
        document.getElementById('siguienteTurnoCola').textContent = 'No hay tickets pendientes.';
        document.getElementById('btnLlamar').disabled = true;
    }

    // --- 2. Actualizar estado del contador ---
    const proximoTurno = String(contador % 100 + 1).padStart(3, '0');
    document.getElementById('estadoContador').textContent = `칔ltimo ticket generado: T-${String(contador).padStart(3, '0')}`;
    document.getElementById('proximoGenerar').textContent = `Pr칩ximo a generar: T-${proximoTurno}`;
}

// ====================================================
// INICIALIZACI칍N Y AUTO-REFRESCO
// ====================================================
window.onload = actualizarVistaAdmin;
setInterval(actualizarVistaAdmin, 3000); 
</script>

</body>
</html>

